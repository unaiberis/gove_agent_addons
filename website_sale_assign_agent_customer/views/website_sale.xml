<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <template id="agent_customer_card">
        <t t-if="request.env.user.sudo().partner_id.agent">
            <div class="card mt-3 mb-3 o_wsaac_agent_customers">
                <div class="card-body">
                    <div>
                        <b>Assigned Customer:</b>
                        <t
                            t-esc="request.env['res.partner'].sudo().browse(request.env['agent.partner'].sudo().search([('agent_id', '=', request.env.user.sudo().partner_id.id)], limit=1).customer_id_chosen_by_agent).sudo().name" />
                    </div>
                </div>
                <div class="card-body">
                    <div>
                        <b>Modo de pago utilizado por el cliente:</b>
                        <t
                            t-esc="request.env['res.partner'].sudo().browse(request.env['agent.partner'].sudo().search([('agent_id', '=', request.env.user.sudo().partner_id.id)], limit=1).customer_id_chosen_by_agent).sudo().customer_payment_mode_id.sudo().name" />
                    </div>
                </div>
                <t t-if="request.website.sale_get_order().order_comments">
                    <div class="card-body">
                        <div>
                            <b>Comentario de la compra:</b>
                            <t
                                t-esc="request.website.sale_get_order().order_comments" />
                        </div>
                    </div>
                </t>
            </div>
            <t
                t-if="not request.env['res.partner'].sudo().browse(request.env['agent.partner'].sudo().search([('agent_id', '=', request.env.user.sudo().partner_id.id)], limit=1).customer_id_chosen_by_agent).sudo()">
                <p>Please select a customer</p>
            </t>
        </t>
    </template>

    <!-- Choose customer "Update Customer" Option -->
    <template id="choose_customer_from_agent">
        <form method="post" action="/shop/update_customer" class="container mt-3">
            <!-- Include the CSRF token as a hidden input -->
            <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()" />

            <div class="row">
                <t
                    t-if="not request.website.sale_get_order() or request.website.sale_get_order()">

                    <div class="col-md-6 mb-3">
                        <h3 class="mb-3">Assign Customer to Order</h3>
                        <select name="agent_customer" class="form-control">
                            <option value="">Select a customer...</option>
                            <t t-foreach="request.env.user.sudo().partner_id.agent_customers"
                                t-as="customer">
                                <option t-att-value="customer.id" t-field="customer.name" />
                            </t>
                        </select>
                        <button type="submit" class="btn btn-primary mt-3">Update Customer</button>
                    </div>
                </t>

                <t t-if="selected_customer and selected_customer.exists()">
                    <div class="col-md-6" t-if="selected_customer">
                        <h1 class="text-uppercase font-weight-bold text-center"
                            style="padding: 15px; border-radius: 5px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
                        animation: growShrink 4s infinite;">
                            <t t-esc="selected_customer.name" />
                        </h1>
                        <p class="text-center text-muted">Selected
                            customer</p>
                    </div>

                    <style>
                        @keyframes growShrink {
                        0%, 100% {
                        transform: scale(0.95);
                        }
                        50% {
                        transform: scale(1.05); /* Adjust the scale factor as needed */
                        }
                        }
                    </style>

                </t>

                <t t-else="">
                    <div class="col-md-6" style="margin: auto; text-align: center;">
                        <div class="bg-light p-3"
                            style="border: 1px solid #ccc; border-radius: 5px;">
                            <p class="text-center">No customer selected yet.</p>
                            <p class="text-center">Please choose a customer to be able to continue
                                purchasing with an agent user</p>
                            <t
                                t-if="request.website.sale_get_order() and request.website.sale_get_order().cart_quantity != 0">
                                <p class="text-center text-muted">Your cart will be emptied when you
                                    change the customer</p>
                            </t>
                        </div>
                    </div>
                </t>

            </div>
        </form>
    </template>


    <template
        id="cart" inherit_id="website_sale.cart">
        <xpath expr="//div[hasclass('clearfix')]" position="after">
            <t t-if="selected_customer">
                <!-- Show assigned customer and its payment mode in the cart page -->
                <t t-call="website_sale_assign_agent_customer.agent_customer_card" />
            </t>
        </xpath>
    </template>


    <template
        id="payment" inherit_id="website_sale.payment">
        <xpath expr="//div[@id='payment_method']" position="before">
            <!-- Show assigned customer and its payment mode in the payment page -->
            <t
                t-if="request.env['agent.partner'].sudo().search([('agent_id', '=', request.env.user.sudo().partner_id.id)], limit=1).customer_id_chosen_by_agent != 0">
                <t t-call="website_sale_assign_agent_customer.agent_customer_card" />
            </t>
        </xpath>
    </template>

    <template
        id="confirmation" inherit_id="website_sale.confirmation">
        <xpath expr="//div[hasclass('oe_cart')]" position="after">
            <t t-if="selected_customer">
                <t t-call="website_sale_assign_agent_customer.agent_customer_card" />
            </t>
        </xpath>
    </template>

    <template inherit_id="website_sale.payment" id="payment_remove_facturation_of_the_agent">
        <xpath
            expr="//div[hasclass('card')]" position="replace">
            <t t-if="not request.env.user.sudo().partner_id.agent">
                <div class="card">
                    <div class="card-body" id="shipping_and_billing">
                        <a class='float-right no-decoration' href='/shop/checkout'><i
                                class="fa fa-edit" /> Edit</a>
                        <t t-set="same_shipping"
                            t-value="bool(order.partner_shipping_id==order.partner_id or only_services)" />
                        <div>
                            <b>Billing<t t-if="same_shipping and not only_services"> &amp; Shipping</t>
                                : </b>
                            <span t-esc='order.partner_id'
                                t-options="dict(widget='contact', fields=['address'], no_marker=True, separator=', ')"
                                class="address-inline" />
                        </div>
                        <div t-if="not same_shipping and not only_services"
                            groups="sale.group_delivery_invoice_address">
                            <b>Shipping: </b>
                            <span t-esc='order.partner_shipping_id'
                                t-options="dict(widget='contact', fields=['address'], no_marker=True, separator=', ')"
                                class="address-inline" />
                        </div>
                    </div>
                </div>
            </t>

        </xpath>
    </template>

    <template
        id="products_item_add_tariff_price" inherit_id="website_sale.products_item">
        <xpath expr="//div[hasclass('product_price')]" position="replace">
            <div class="product_price" itemprop="offers" itemscope="itemscope"
                itemtype="http://schema.org/Offer">
                <div style="width: 100%; text-align: left;">
                    <t
                        t-if="combination_info['price'] and combination_info['PVP'] != combination_info['price']">
                        <div style="font-size: x-small;">
                            <span>PCT</span>
                            <span t-esc="combination_info['price']"
                                t-options="{'widget': 'monetary', 'display_currency': website.currency_id}" />
                        </div>
                    </t>
                </div>

                <t t-if="combination_info['PVP']">
                    <div style="width: 100%; text-align: left;">
                        <div style="font-size: x-small;">
                            <span>PVP</span>
                            <span t-esc="combination_info['PVP']"
                                t-options="{'widget': 'monetary', 'display_currency': website.currency_id}" />
                        </div>
                    </div>
                </t>

                <span
                    style="width: 100%; display: inline-block; font-size: smaller; text-align: left;">
                    <t t-set="is_available"
                        t-value="request.env['product.template'].sudo().search([('id', '=', product.id)]).virtual_available > 0" />

                    <span t-if="is_available" style="color: green;">
                        <span>Stock</span>
                    </span>

                    <span t-else="" style="color: red;">
                        <span>No stock</span>
                    </span>
                </span>
                <style>
                    .css_quantity {
                    width: 110px;
                    text-align: center;
                    float: right;
                    height: 38px;
                    }

                    .js_quantity {
                    font-size: x-small;
                    height: 100%;
                    display: flex;
                    align-items: center; /* Center vertically */
                    justify-content: center; /* Center horizontally */
                    text-align: center;
                    padding: 0;
                    }

                    .input-group-prepend,
                    .input-group-append {
                    display: inline-block;
                    }
                </style>

                <t t-if="website_sale_order">
                    <t t-foreach="website_sale_order.website_order_line" t-as="line">
                        <t t-set="prod_templ_id" t-value="line.product_id.product_tmpl_id" />
                        <t t-set="bin_prod_templ_id"
                            t-value="request.env['product.template'].sudo().search([('id', '=', product.id)])" />
                        <t t-if="bin_prod_templ_id and 0">

                            <t t-if="prod_templ_id == bin_prod_templ_id">
                                <div class="css_quantity input-group mx-auto border">
                                    <div class="input-group-prepend">
                                        <a
                                            t-attf-href="'#?sign=minus&amp;product_id=' + str(product_id)"
                                            class="btn btn-link js_add_cart_json d-none d-md-inline-block"
                                            aria-label="Remove one" title="Remove one">
                                            <i class="fa fa-minus"></i>
                                        </a>
                                    </div>
                                    <div class="js_quantity form-control quantity"
                                        t-att-data-line-id="line.id"
                                        t-att-data-product-id="line.product_id.id"
                                        contenteditable="true">
                                        <t t-esc="int(line.product_uom_qty)" />
                                    </div>
                                    <div class="input-group-append">
                                        <a
                                            t-attf-href="'#?sign=plus&amp;product_id=' + bin_prod_templ_id.id"
                                            class="btn btn-link float_left js_add_cart_json d-none d-md-inline-block"
                                            aria-label="Add one" title="Add one">
                                            <i class="fa fa-plus"></i>
                                        </a>
                                    </div>
                                </div>
                            </t>
                            <t t-else="">
                                <div class="css_quantity input-group mx-auto border">
                                    <div class="input-group-prepend">
                                        <a
                                            t-attf-href="'#?sign=minus&amp;product_id=' + str(product_id)"
                                            class="btn btn-link js_add_cart_json d-none d-md-inline-block"
                                            aria-label="Remove one" title="Remove one">
                                            <i class="fa fa-minus"></i>
                                        </a>
                                    </div>
                                    <div class="js_quantity form-control quantity"
                                        t-att-data-line-id="line.id"
                                        t-att-data-product-id="line.product_id.id"
                                        contenteditable="true"> 0
                                    </div>
                                    <div class="input-group-append">
                                        <a
                                            t-attf-href="'#?sign=plus&amp;product_id=' + bin_prod_templ_id.id"
                                            class="btn btn-link float_left js_add_cart_json d-none d-md-inline-block"
                                            aria-label="Add one" title="Add one">
                                            <i class="fa fa-plus"></i>
                                        </a>
                                    </div>
                                </div>
                            </t>
                        </t>
                    </t>
                </t>
            </div>
        </xpath>


        <!-- CHANGE STYLE OF EVERY PRODUCT TO SHOW IMAGE BIGGER AND MAKE BOX HEIGHT BIGGER -->

        <xpath
            expr="//form[hasclass('oe_product_cart')]//div[hasclass('o_wsale_product_information')]"
            position="before">
            <style>
                form.card.oe_product_cart{
                height: 280px;
                }
                tr{
                height: 300px;
                }
                .oe_product.oe_image_full .o_wsale_product_information{
                position: relative;
                }
            </style>
        </xpath>
    </template>


    <!-- PRODUCTS XPATH -->

    <template id="products_inserted">
        <t t-call="website.layout">
            <t t-set="additional_title">Shop</t>
            <div id="wrap" class="js_sale">
                <div class="oe_structure oe_empty" id="oe_structure_website_sale_products_1" />
                <div class="container oe_website_sale">
                    <div
                        class="products_pager form-inline flex-md-nowrap justify-content-between justify-content-md-center">
                        <t t-call="website_sale.search">
                            <t t-set="_classes" t-valuef="w-100 w-md-auto mt-2" />
                        </t>
                        <!-- Remove the option to choose a pricelist -->
                        <!-- <t t-call="website_sale.pricelist_list">
                            <t t-set="_classes" t-valuef="mt-2 ml-md-2" />
                        </t> -->
                        <t t-call="website.pager">
                            <t t-set="_classes" t-valuef="mt-2 ml-md-2" />
                        </t>
                    </div>
                    <div class="row o_wsale_products_main_row">
                        <t t-set="enable_left_column" t-value="True" />

                        <div t-if="enable_left_column" id="products_grid_before"
                            class="col-lg-3" />
                        <div id="products_grid"
                            t-attf-class="col #{'o_wsale_layout_list' if layout_mode == 'list' else ''}">
                            <t t-if="category">
                                <t t-set='editor_msg'>Drag building blocks here to customize the
                                    header for "<t t-esc='category.name' />" category.</t>
                                <div class="mb16" id="category_header"
                                    t-att-data-editor-message="editor_msg"
                                    t-field="category.website_description" />
                            </t>
                            <div t-if="bins" class="o_wsale_products_grid_table_wrapper">
                                <table class="table table-borderless m-0"
                                    t-att-data-ppg="ppg" t-att-data-ppr="ppr">
                                    <colgroup t-ignore="true">
                                        <!-- Force the number of columns (useful when only
                                    one row of (x < ppr) products) -->
                                        <col t-foreach="ppr" t-as="p" />
                                    </colgroup>
                                    <tbody>
                                        <tr t-foreach="bins" t-as="tr_product">
                                            <t t-foreach="tr_product" t-as="td_product">
                                                <t t-if="td_product">
                                                    <t t-set="product"
                                                        t-value="td_product['product']" />
                                                    <!-- We use t-attf-class here to allow
                                                easier customization -->
                                                    <td
                                                        t-att-colspan="td_product['x'] != 1 and td_product['x']"
                                                        t-att-rowspan="td_product['y'] != 1 and td_product['y']"
                                                        t-attf-class="oe_product"
                                                        t-att-data-ribbon-id="td_product['ribbon'].id">
                                                        <div
                                                            t-attf-class="o_wsale_product_grid_wrapper o_wsale_product_grid_wrapper_#{td_product['x']}_#{td_product['y']}">
                                                            <t
                                                                t-call="website_sale.products_item">
                                                                <t t-set="product_image_big"
                                                                    t-value="td_product['x'] + td_product['y'] &gt; 2" />
                                                            </t>
                                                        </div>
                                                    </td>
                                                </t>
                                                <td t-else="" />
                                            </t>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <t t-else="">
                                <div class="text-center text-muted">
                                    <t t-if="not search">
                                        <h3 class="mt8">No product defined</h3>
                                        <p t-if="category">No product defined in category "<strong
                                                t-esc="category.display_name" />".</p>
                                    </t>
                                    <t t-else="">
                                        <h3 class="mt8">No results</h3>
                                        <p>No results for "<strong t-esc='search' />"<t
                                                t-if="category"> in category "<strong
                                                    t-esc="category.display_name" />"</t>.</p>
                                    </t>
                                    <p t-ignore="true"
                                        groups="sales_team.group_sale_manager">Click <i>
                                            'New'</i> in the top-right corner to create your first
                                        product.</p>
                                </div>
                            </t>
                        </div>
                    </div>
                    <div class="products_pager form-inline justify-content-center py-3">
                        <t t-call="website.pager" />
                    </div>
                </div>
                <div class="oe_structure oe_empty" id="oe_structure_website_sale_products_2" />
            </div>
        </t>
    </template>

    <!-- CATEGORY ID XPATH DANAK -->
    <template id="products_images_full" name="Images Full"
        inherit_id="website_sale_assign_agent_customer.products_inserted"
        active="True" customize_show="True">
        <xpath expr="//t[@t-foreach='tr_product']//td" position="attributes">
            <attribute name="t-attf-class" add="oe_image_full" separator=" " />
        </xpath>
    </template>

    <template id="sort" inherit_id="website_sale_assign_agent_customer.products_inserted"
        customize_show="True" name="Show Sort by">
        <xpath expr="//div[hasclass('products_pager')]/t[@t-call][last()]" position="after">
            <t t-set="list_price_desc_label">Catalog price: High to Low</t>
            <t t-set="list_price_asc_label">Catalog price: Low to High</t>
            <t t-set="name_asc_label">Name: A to Z</t>
            <t t-set="name_desc_label">Name: Z to A</t>
            <t t-set="website_sale_sortable"
                t-value="[
            (list_price_desc_label, 'list_price desc'),
            (list_price_asc_label, 'list_price asc'),
            (name_asc_label, 'name asc'),
            (name_desc_label, 'name desc')
        ]" />
            <t t-set="website_sale_sortable_current"
                t-value="[sort for sort in website_sale_sortable if sort[1]==request.params.get('order', '')]" />
            <div class="dropdown mt-2 ml-md-2 dropdown_sorty_by">
                <a role="button" href="#" class="dropdown-toggle btn btn-secondary"
                    data-toggle="dropdown">
                    <span class="d-none d-lg-inline">
                        <t t-if='len(website_sale_sortable_current)'> Sorting by : <t
                                t-raw='website_sale_sortable_current[0][0]' />
                        </t>
                        <t t-else='1'>
                            Sort by
                        </t>
                    </span>
                    <i class="fa fa-sort-amount-asc d-lg-none" />
                </a>
                <div class="dropdown-menu dropdown-menu-right" role="menu">
                    <t t-foreach="website_sale_sortable" t-as="sortby">
                        <a role="menuitem" rel="noindex,nofollow"
                            t-att-href="keep('/shop', order=sortby[1])" class="dropdown-item">
                            <span t-raw="sortby[0]" />
                        </a>
                    </t>
                </div>
            </div>
        </xpath>
    </template>

    <template id="add_grid_or_list_option"
        inherit_id="website_sale_assign_agent_customer.products_inserted"
        active="True"
        customize_show="True" name="Grid or List button">
        <xpath expr="//div[hasclass('products_pager')]/t[@t-call][last()]" position="after">
            <div
                class="btn-group btn-group-toggle mt-2 ml-md-2 d-none d-sm-inline-flex o_wsale_apply_layout"
                data-toggle="buttons">
                <label
                    t-attf-class="btn btn-secondary #{'active' if layout_mode != 'list' else None} fa fa-th-large o_wsale_apply_grid"
                    title="Grid">
                    <input type="radio" name="wsale_products_layout"
                        t-att-checked="'checked' if layout_mode != 'list' else None" />
                </label>
                <label
                    t-attf-class="btn btn-secondary #{'active' if layout_mode == 'list' else None} fa fa-th-list o_wsale_apply_list"
                    title="List">
                    <input type="radio" name="wsale_products_layout"
                        t-att-checked="'checked' if layout_mode == 'list' else None" />
                </label>
            </div>
        </xpath>
    </template>

    <template id="products_categories"
        inherit_id="website_sale_assign_agent_customer.products_inserted"
    >
        <xpath expr="//div[@id='products_grid_before']" position="before">
            <t t-set="enable_left_column" t-value="True" />
        </xpath>
        <xpath expr="//div[@id='products_grid_before']" position="inside">
            <button type="button" class="btn btn-link d-lg-none"
                data-target="#wsale_products_categories_collapse" data-toggle="collapse">
                Show categories
            </button>
            <div class="collapse d-lg-block" id="wsale_products_categories_collapse">
                <ul class="nav nav-pills flex-column mb-2">
                    <li class="nav-item">
                        <a t-att-href="keep('/shop', category=0)"
                            t-attf-class="nav-link #{'' if category else 'active'} o_not_editable">All
                            Products</a>
                    </li>
                    <t t-foreach="categories" t-as="c">
                        <t t-call="website_sale.categories_recursive" />
                    </t>
                </ul>
            </div>
        </xpath>
    </template>
    <template id="products_attributes"
        inherit_id="website_sale_assign_agent_customer.products_inserted"
        active="True"
        customize_show="True" name="Product Attribute's Filters">
        <xpath expr="//div[@id='products_grid_before']" position="before">
            <t t-set="enable_left_column" t-value="True" />
        </xpath>
        <xpath expr="//div[@id='products_grid_before']" position="inside">
            <button type="button" class="btn btn-link d-lg-none"
                data-target="#wsale_products_attributes_collapse" data-toggle="collapse">
                Show options
            </button>
            <div class="collapse d-lg-block" id="wsale_products_attributes_collapse">
                <form class="js_attributes mb-2" method="get">
                    <input t-if="category" type="hidden" name="category" t-att-value="category.id" />
                    <input type="hidden" name="search" t-att-value="search" />
                    <input type="hidden" name="order" t-att-value="order" />
                    <ul class="nav nav-pills flex-column">
                        <t t-foreach="attributes" t-as="a">
                            <li t-if="a.value_ids and len(a.value_ids) &gt; 1" class="nav-item">
                                <div>
                                    <strong t-field="a.name" />
                                </div>
                                <t t-if="a.display_type == 'select'">
                                    <select class="form-control" name="attrib">
                                        <option value="" />
                                        <t t-foreach="a.value_ids" t-as="v">
                                            <option t-att-value="'%s-%s' % (a.id,v.id)"
                                                t-esc="v.name" t-att-selected="v.id in attrib_set" />
                                        </t>
                                    </select>
                                </t>
                                <t t-if="a.display_type == 'radio'">
                                    <ul class="nav nav-pills flex-column">
                                        <t t-foreach="a.value_ids" t-as="v">
                                            <li class="nav-item">
                                                <label style="padding: 0; margin: 0"
                                                    t-attf-class="nav-link#{' active' if v.id in attrib_set else ''}">
                                                    <input type="checkbox" name="attrib"
                                                        t-att-value="'%s-%s' % (a.id,v.id)"
                                                        t-att-checked="'checked' if v.id in attrib_set else None" />
                                                    <span style="font-weight: normal"
                                                        t-field="v.name" />
                                                </label>
                                            </li>
                                        </t>
                                    </ul>
                                </t>
                                <t t-if="a.display_type == 'color'">
                                    <t t-foreach="a.value_ids" t-as="v">
                                        <label
                                            t-attf-style="background-color:#{v.html_color or v.name}"
                                            t-attf-class="css_attribute_color #{'active' if v.id in attrib_set else ''}">
                                            <input type="checkbox" name="attrib"
                                                t-att-value="'%s-%s' % (a.id,v.id)"
                                                t-att-checked="'checked' if v.id in attrib_set else None"
                                                t-att-title="v.name" />
                                        </label>
                                    </t>
                                </t>
                            </li>
                        </t>
                    </ul>
                </form>
            </div>
        </xpath>
    </template>

    <template id="products_list_view"
        inherit_id="website_sale_assign_agent_customer.products_inserted"
        active="True"
        customize_show="True" name="List View (by default)">
        <xpath expr="//div[@id='products_grid']" position="after">
            <!-- Nothing to do, this view is only meant to allow the server -->
            <!-- to know if the list view layout should be used -->
        </xpath>
    </template>
    <!-- insert_customer_choose_option_and_selected_client_in_product_list -->
    <template id="insert_customer_choose_option_and_selected_client_in_product_list"
        inherit_id="website_sale_assign_agent_customer.products_inserted">
        <xpath expr="//div[@id='oe_structure_website_sale_products_1']" position="before">
            <t
                t-if="not request.website.is_public_user() and request.env.user.sudo().partner_id.agent and selected_customer">
                <t t-call="website_sale_assign_agent_customer.choose_customer_from_agent" />
            </t>
        </xpath>
    </template>

    <template id="products" inherit_id="website_sale.products">
        <xpath expr="//t[@t-call='website.layout']" position="replace">
            <!-- If user is agent and a customer is selected show products -->
            <t
                t-if="not request.website.is_public_user() and request.env.user.sudo().partner_id.agent and selected_customer">
                <t t-call="website_sale_assign_agent_customer.products_inserted" />
            </t>
            <!-- If user is agent and a customer is not selected then choose a customer -->
            <t
                t-elif="not request.website.is_public_user() and request.env.user.sudo().partner_id.agent">
                <t t-call="website.layout">
                    <t t-call="website_sale_assign_agent_customer.choose_customer_from_agent" />
                </t>
            </t>
            <!-- If user is not an agent show products -->
            <t t-else="">
                <t t-call="website_sale_assign_agent_customer.products_inserted" />
            </t>
        </xpath>
    </template>
</odoo>