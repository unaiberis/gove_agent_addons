<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <template id="agent_customer_card">
        <t t-if="request.env.user.sudo().partner_id.agent">
            <div class="card mt-3 mb-3 o_wsaac_agent_customers">
                <div class="card-body">
                    <div>
                        <b>Assigned Customer:</b>
                        <t
                            t-esc="request.env['res.partner'].sudo().browse(request.env['agent.partner'].sudo().search([('agent_id', '=', request.env.user.sudo().partner_id.id)], limit=1).customer_id_chosen_by_agent).sudo().name" />
                    </div>
                </div>
                <div class="card-body">
                    <div>
                        <b>Modo de pago utilizado por el cliente:</b>
                        <t t-set="customer_id"
                            t-value="int(request.env['agent.partner'].sudo().search([('agent_id', '=', request.env.user.sudo().partner_id.id)], limit=1).customer_id_chosen_by_agent)" />

                        <t t-set="property_record"
                            t-value="request.env['ir.property'].sudo().search([
                            ('value_reference', 'ilike', 'account.payment.mode'),
                            ('res_id', '=', 'res.partner,' + str(customer_id))
                        ], limit=1)" />

                        <t t-if="property_record">
                            <t t-set="payment_mode_id"
                                t-value="int(property_record.value_reference.split(',')[1])" />
                            <t t-set="payment_mode"
                                t-value="request.env['account.payment.mode'].sudo().browse(payment_mode_id)" />
                            <t t-esc="payment_mode.note" />
                        </t>
                    </div>


                </div>
                <t t-if="request.website.sale_get_order().order_comments">
                    <div class="card-body">
                        <div>
                            <b>Comentario de la compra:</b>
                            <t
                                t-esc="request.website.sale_get_order().order_comments" />
                        </div>
                    </div>
                </t>
            </div>
            <t
                t-if="not request.env['res.partner'].sudo().browse(request.env['agent.partner'].sudo().search([('agent_id', '=', request.env.user.sudo().partner_id.id)], limit=1).customer_id_chosen_by_agent).sudo()">
                <p>Please select a customer</p>
            </t>
        </t>
    </template>

    <template id="customer_card">
        <div class="card mt-3 mb-3 o_wsaac_agent_customers">
            <div class="card-body">
                <div>
                    <b>Modo de pago utilizado por el cliente:</b>
                    <t
                        t-esc="request.env.user.partner_id.sudo().customer_payment_mode_id.sudo().name if request.env.user.partner_id and request.env.user.partner_id.customer_payment_mode_id else ''" />
                </div>
            </div>
            <t t-if="request.website.sale_get_order().order_comments">
                <div class="card-body">
                    <div>
                        <b>Comentario de la compra:</b>
                        <t
                            t-esc="request.website.sale_get_order().order_comments" />
                    </div>
                </div>
            </t>
        </div>
    </template>

    <!-- Choose customer "Update Customer" Option -->
    <template id="choose_customer_from_agent">
        <form method="post" action="/shop/update_customer" class="container mt-3">
            <!-- Include the CSRF token as a hidden input -->
            <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()" />

            <div class="row">
                <t
                    t-if="not request.website.sale_get_order() or request.website.sale_get_order()">

                    <div class="col-md-6 mb-3">
                        <h3 class="mb-3">Assign Customer to Order</h3>
                        <select name="agent_customer" class="form-control">
                            <option value="">Select a customer...</option>
                            <t t-foreach="request.env.user.sudo().partner_id.agent_customers"
                                t-as="customer">
                                <option t-att-value="customer.id" t-field="customer.name" />
                            </t>
                        </select>
                        <button type="submit" class="btn btn-primary mt-3">Update Customer</button>
                    </div>
                </t>

                <t t-if="selected_customer and selected_customer.exists()">
                    <div class="col-md-6" t-if="selected_customer">
                        <h1 class="text-uppercase font-weight-bold text-center"
                            style="padding: 15px; border-radius: 5px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
                        animation: growShrink 4s infinite;">
                            <t t-esc="selected_customer.name" />
                        </h1>
                        <p class="text-center text-muted">Selected
                            customer</p>
                    </div>

                    <style>
                        @keyframes growShrink {
                        0%, 100% {
                        transform: scale(0.95);
                        }
                        50% {
                        transform: scale(1.05); /* Adjust the scale factor as needed */
                        }
                        }
                    </style>

                </t>

                <t t-else="">
                    <div class="col-md-6" style="margin: auto; text-align: center;">
                        <div class="bg-light p-3"
                            style="border: 1px solid #ccc; border-radius: 5px;">
                            <p class="text-center">No customer selected yet.</p>
                            <p class="text-center">Please choose a customer to be able to continue
                                purchasing with an agent user</p>
                            <t
                                t-if="request.website.sale_get_order() and request.website.sale_get_order().cart_quantity != 0">
                                <p class="text-center text-muted">Your cart will be emptied when you
                                    change the customer</p>
                            </t>
                        </div>
                    </div>
                </t>

            </div>
        </form>
    </template>

    <!-- Show assigned customer and its payment mode in the payment page -->

    <template
        id="payment" inherit_id="website_sale.payment">
        <xpath expr="//div[@id='payment_method']" position="before">
            <!-- Show assigned customer and its payment mode in the payment page -->
            <t
                t-if="request.env['agent.partner'].sudo().search([('agent_id', '=', request.env.user.sudo().partner_id.id)], limit=1).customer_id_chosen_by_agent != 0">
                <t t-call="website_sale_assign_agent_customer.agent_customer_card" />
            </t>
            <t t-elif="not request.env.user.sudo().partner_id.agent">
                <t t-call="website_sale_assign_agent_customer.customer_card" />
            </t>
        </xpath>
    </template>

    <template
        id="confirmation" inherit_id="website_sale.confirmation">
        <xpath expr="//div[hasclass('oe_cart')]" position="after">
            <t t-if="selected_customer">
                <t t-call="website_sale_assign_agent_customer.agent_customer_card" />
            </t>
        </xpath>
    </template>

    <!-- REMOVE FACTURATION FROM PAYMENT IF AGENT -->

    <template inherit_id="website_sale.payment" id="payment_remove_facturation_of_the_agent">
        <xpath
            expr="//div[hasclass('card')]" position="replace">
            <t t-if="not request.env.user.sudo().partner_id.agent">
                <div class="card">
                    <div class="card-body" id="shipping_and_billing">
                        <a class='float-right no-decoration' href='/shop/checkout'><i
                                class="fa fa-edit" /> Edit</a>
                        <t t-set="same_shipping"
                            t-value="bool(order.partner_shipping_id==order.partner_id or only_services)" />
                        <div>
                            <b>Billing<t t-if="same_shipping and not only_services"> &amp; Shipping</t>
                                : </b>
                            <span t-esc='order.partner_id'
                                t-options="dict(widget='contact', fields=['address'], no_marker=True, separator=', ')"
                                class="address-inline" />
                        </div>
                        <div t-if="not same_shipping and not only_services"
                            groups="sale.group_delivery_invoice_address">
                            <b>Shipping: </b>
                            <span t-esc='order.partner_shipping_id'
                                t-options="dict(widget='contact', fields=['address'], no_marker=True, separator=', ')"
                                class="address-inline" />
                        </div>
                    </div>
                </div>
            </t>

        </xpath>
    </template>

    <!-- ADD PCT, PVP AND STOCK OR NO STOCK IN EACH PRODUCT -->

    <template
        id="products_item_add_tariff_price" inherit_id="website_sale.products_item">
        <xpath expr="//div[hasclass('product_price')]" position="replace">
            <div class="product_price" itemprop="offers" itemscope="itemscope"
                itemtype="http://schema.org/Offer">
                <div style="width: 100%; text-align: left;">
                    <t
                        t-if="combination_info['price'] and combination_info['PVP'] != combination_info['price']">
                        <div style="font-size: x-small;">
                            <span>PCT</span>
                            <span t-esc="combination_info['price']"
                                t-options="{'widget': 'monetary', 'display_currency': website.currency_id}" />
                        </div>
                    </t>
                </div>

                <t t-if="combination_info['PVP']">
                    <div style="width: 100%; text-align: left;">
                        <div style="font-size: x-small;">
                            <span>PVP</span>
                            <span t-esc="combination_info['PVP']"
                                t-options="{'widget': 'monetary', 'display_currency': website.currency_id}" />
                        </div>
                    </div>
                </t>

                <span
                    style="width: 100%; display: inline-block; font-size: smaller; text-align: left;">
                    <t t-set="is_available"
                        t-value="request.env['product.template'].sudo().search([('id', '=', product.id)]).virtual_available > 0" />

                    <span t-if="is_available" style="color: green;">
                        <span>Stock</span>
                    </span>

                    <span t-else="" style="color: red;">
                        <span>No stock</span>
                    </span>
                </span>


                <!-- ADD TO CART FUNTZIONATZEUNA -->

                <!-- <div class="css_quantity input-group" contenteditable="false">
                    <div class="input-group-prepend">
                        <a t-attf-href="#" class="btn btn-secondary js_add_cart_json"
                            aria-label="Remove one" title="Remove one">
                            <i class="fa fa-minus"></i>
                        </a>
                    </div>
                    <input type="text" class="form-control quantity" data-min="1" name="add_qty"
                        t-att-value="add_qty or 1" />
                    <div class="input-group-append">
                        <a t-attf-href="#" class="btn btn-secondary float_left js_add_cart_json"
                            aria-label="Add one" title="Add one">
                            <i class="fa fa-plus"></i>
                        </a>
                    </div>
                </div>
                <a role="button" id="add_to_cart"
                    class="btn btn-primary btn-lg mt16 js_check_product a-submit d-block d-sm-inline-block"
                    href="#"><i class="fa fa-shopping-cart" /> Add to Cart</a> -->


                    <!-- <table class="mb16 table table-striped table-sm js_cart_lines" id="cart_products" t-if="website_sale_order and website_sale_order.website_order_line">
                        <tbody>
                            <t t-foreach="website_sale_order.website_order_line" t-as="line">
                                <tr t-att-class="'optional_product info' if line.linked_line_id else None">
                                    <td class="text-center td-qty">
                                        <div class="css_quantity input-group mx-auto">
                                            <div class="input-group-prepend">
                                                <a t-attf-href="#" class="btn btn-link js_add_cart_json d-none d-md-inline-block" aria-label="Remove one" title="Remove one">
                                                    <i class="fa fa-minus"></i>
                                                </a>
                                            </div>
                                            <input type="text" class="js_quantity form-control quantity" t-att-data-line-id="line.id" t-att-data-product-id="line.product_id.id" t-att-value="int(line.product_uom_qty) == line.product_uom_qty and int(line.product_uom_qty) or line.product_uom_qty" />
                                            <div class="input-group-append">
                                                <a t-attf-href="#" class="btn btn-link float_left js_add_cart_json d-none d-md-inline-block" aria-label="Add one" title="Add one">
                                                    <i class="fa fa-plus"></i>
                                                </a>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="text-center td-price" name="price">
                                        <t t-set="combination" t-value="line.product_id.product_template_attribute_value_ids + line.product_no_variant_attribute_value_ids"/>
                                        <t t-set="combination_info" t-value="line.product_id.product_tmpl_id._get_combination_info(combination, pricelist=website_sale_order.pricelist_id)"/>
            
                                        <t groups="account.group_show_line_subtotals_tax_excluded" t-if="(website_sale_order.pricelist_id.discount_policy == 'without_discount' and website_sale_order.currency_id.compare_amounts(list_price_converted, line.price_reduce_taxexcl) == 1) or website_sale_order.currency_id.compare_amounts(line.price_unit, line.price_reduce) == 1" name="order_line_discount">
                                            <del t-attf-class="#{'text-danger mr8'}" style="white-space: nowrap;" t-esc="list_price_converted" t-options="{'widget': 'monetary', 'display_currency': website_sale_order.currency_id}" />
                                        </t>
                                        <span t-field="line.price_reduce_taxexcl" style="white-space: nowrap;" t-options="{'widget': 'monetary', 'display_currency': website_sale_order.currency_id}" groups="account.group_show_line_subtotals_tax_excluded" />
                                        <t groups="account.group_show_line_subtotals_tax_included" t-if="(website_sale_order.pricelist_id.discount_policy == 'without_discount' and website_sale_order.currency_id.compare_amounts(list_price_converted, line.price_reduce_taxinc) == 1) or website_sale_order.currency_id.compare_amounts(line.price_unit, line.price_reduce) == 1" name="order_line_discount">
                                            <del t-attf-class="#{'text-danger mr8'}" style="white-space: nowrap;" t-esc="list_price_converted" t-options="{'widget': 'monetary', 'display_currency': website_sale_order.currency_id}" />
                                        </t>
                                        <span t-field="line.price_reduce_taxinc" style="white-space: nowrap;" t-options="{'widget': 'monetary', 'display_currency': website_sale_order.currency_id}" groups="account.group_show_line_subtotals_tax_included" />
                                    </td>
                                    <td class="td-action">
                                        <a href='#' aria-label="Remove from cart" title="Remove from cart" class='js_delete_product no-decoration'> <small><i class='fa fa-trash-o'></i></small></a>
                                    </td>
                                </tr>
                            </t>
                        </tbody>
                    </table> -->


                <!-- PRUEBAS BOTON AÑADIR AL CARRITO -->

                <!-- <t t-set="product_variant_id"
                t-value="product._get_first_possible_variant_id()" />
                <input name="product_id" t-att-value="product_variant_id" type="hidden" />
                <t t-if="product_variant_id">
                    <a href="#" role="button" class="btn btn-secondary a-submit"
                        aria-label="Shopping cart" title="Shopping cart">
                        <span class="fa fa-shopping-cart"></span>
                        <span class="fa fa-shopping-cart" style="content: 'Añadir al carrito';"></span>
                    </a>
                </t> -->
            </div>
        </xpath>


        <!-- CHANGE STYLE OF EVERY PRODUCT TO SHOW IMAGE BIGGER AND MAKE BOX HEIGHT BIGGER -->

        <xpath
            expr="//form[hasclass('oe_product_cart')]//div[hasclass('o_wsale_product_information')]"
            position="before">
            <style>
                form.card.oe_product_cart{
                    height: 280px;
                }
                .table-borderless tr {
                    height: 300px;
                }
                .oe_product.oe_image_full .o_wsale_product_information{
                    position: relative;
                }
            </style>
        </xpath>
    </template>


    <!-- insert_customer_choose_option_and_selected_client_in_product_list -->
    <template id="insert_customer_choose_option_and_selected_client_in_product_list"
        inherit_id="website_sale_assign_agent_customer.products_inserted">
        <xpath expr="//div[@id='oe_structure_website_sale_products_1']" position="before">
            <t
                t-if="not request.website.is_public_user() and request.env.user.sudo().partner_id.agent and selected_customer">
                <t t-call="website_sale_assign_agent_customer.choose_customer_from_agent" />
            </t>
        </xpath>
    </template>

    <template id="products" inherit_id="website_sale.products">
        <xpath expr="//t[@t-call='website.layout']" position="replace">
            <!-- If user is agent and a customer is selected show products -->
            <t
                t-if="not request.website.is_public_user() and request.env.user.sudo().partner_id.agent and selected_customer">
                <t t-call="website_sale_assign_agent_customer.products_inserted" />
            </t>
            <!-- If user is agent and a customer is not selected then choose a customer -->
            <t
                t-elif="not request.website.is_public_user() and request.env.user.sudo().partner_id.agent">
                <t t-call="website.layout">
                    <t t-call="website_sale_assign_agent_customer.choose_customer_from_agent" />
                </t>
            </t>
            <!-- If user is not an agent show products -->
            <t t-else="">
                <t t-call="website_sale_assign_agent_customer.products_inserted" />
            </t>
        </xpath>
    </template>

    <!-- REMOVE PRICELIST FROM PRODUCT FROM WEBSITE SALE -->

    <template id="remove_pricelist_from_product_from_website_sale" inherit_id="website_sale.product"
        name="Remove Pricelist from Product Form in Website sale">
        <xpath
            expr="//div[@class='col-md-8']/div[@class='form-inline justify-content-end']/t[@t-call='website_sale.pricelist_list']"
            position="replace">
        </xpath>
    </template>

</odoo>